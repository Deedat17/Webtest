#include <MHZ19.h>
#include <DHT.h>
#include <Wire.h>
#include <WiFi.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <time.h>
#include <esp_now.h>
#include <Firebase_ESP_Client.h>

// PIN CONFIGURATION
#define RX_PIN 16
#define TX_PIN 17
#define BAUDRATE 9600
#define DHTPIN_1 5
#define DHTTYPE DHT22
const int MQ4_Pin = 34;
const float R_0 = 945.0;

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1

// Inisialisasi sensor dan tampilan
MHZ19 myMHZ19;
HardwareSerial mySerial(1);
DHT dht1(DHTPIN_1, DHTTYPE);
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

const float V_REF = 3.3;
const int ADC_RESOLUTION = 4095;

typedef struct struct_sender1 {
  int co2;
  float methane;
  float temperature;
  float humidity;
  float methaneAnalog;
} struct_sender1;

struct_sender1 Sender1;

uint8_t receiverMac[] = {0xEC, 0x64, 0xC9, 0x5E, 0x3A, 0x78};

#define WIFI_SSID "Anwar"
#define WIFI_PASSWORD "112233445566"
#define API_KEY "AIzaSyBOiNfEE3BfWnLMzwzpvghS0p-MHVduwUo"
#define DATABASE_URL "https://decompose-5702c-default-rtdb.asia-southeast1.firebasedatabase.app/"
#define USER_EMAIL "deedat2003@gmail.com"
#define USER_PASSWORD "Vitriol17"

FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

String databasePath = "AllData/CO2";

typedef struct {
  int co2;
  float methane, temperature, humidity, methaneAnalog;
  time_t timestamp;
} Co2Data;

Co2Data co2Data;

String statusFirebase = "";
String statusESPNow = "";

// Fungsi waktu
String getCurrentTime() {
  time_t now = time(nullptr);
  if (now <= 0) return "Time_Error";
  struct tm timeinfo;
  if (!localtime_r(&now, &timeinfo)) return "Time_Error";

  char buffer[25];
  strftime(buffer, sizeof(buffer), "%Y-%m-%d_%H-%M-%S", &timeinfo);
  return String(buffer);
}

// Fungsi hitung PPM metana
float getMethanePPM() {
  int sensorValue = analogRead(MQ4_Pin);
  float voltage = sensorValue * (V_REF / ADC_RESOLUTION);
  float ppm = (R_0 * (V_REF / voltage - 1)) / 100;
  return ppm;
}

// Inisialisasi ESP-NOW
void initESPNow() {
  if (esp_now_init() != ESP_OK) {
    Serial.println("❌ Gagal inisialisasi ESP-NOW");
    return;
  }

  esp_now_peer_info_t peerInfo = {};
  memcpy(peerInfo.peer_addr, receiverMac, 6);
  peerInfo.channel = 0;
  peerInfo.encrypt = false;

  if (!esp_now_is_peer_exist(receiverMac)) {
    if (esp_now_add_peer(&peerInfo) != ESP_OK) {
      Serial.println("❌ Gagal menambahkan peer ESP-NOW");
    } else {
      Serial.println("✅ Peer ESP-NOW ditambahkan");
    }
  }
}

// Tampilkan data di OLED
void showOLED() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0, 0);

  display.print("CO2: ");
  display.print(co2Data.co2);
  display.println(" ppm");

  display.print("Methane: ");
  display.print((int)round(co2Data.methane));
  display.println(" ppm");

  display.print("Temp: ");
  display.print(co2Data.temperature);
  display.println(" C");

  display.print("Humid: ");
  display.print(co2Data.humidity);
  display.println(" %");

  display.print("Time: ");
  display.println(getCurrentTime());

  display.setCursor(0, 56);
  display.printf("%s | %s", statusFirebase.c_str(), statusESPNow.c_str());

  display.display();
}

// Kirim data via ESP-NOW
void sendData1(int CO2, float methane, float temperature, float humidity, float methaneAnalog) {
  Sender1.co2 = CO2;
  Sender1.methane = round(methane);
  Sender1.temperature = temperature;
  Sender1.humidity = humidity;
  Sender1.methaneAnalog = methaneAnalog;

  esp_err_t result = esp_now_send(receiverMac, (uint8_t *)&Sender1, sizeof(Sender1));
  if (result == ESP_OK) {
    Serial.println("📡 ESP-NOW: Data sent successfully");
    statusESPNow = "ESP: OK";
  } else {
    Serial.println("❌ ESP-NOW: Error sending data");
    statusESPNow = "ESP: ERR";
  }
}

// Upload data ke Firebase
void uploadToFirebase() {
  if (!Firebase.ready()) return;

  String waktu = getCurrentTime();
  if (waktu == "Time_Error") return;

  String path = databasePath + "/" + waktu;

  FirebaseJson json;
  json.add("CO2", co2Data.co2);
  json.add("methane", co2Data.methane);
  json.add("temperature", co2Data.temperature);
  json.add("humidity", co2Data.humidity);
  json.add("analogvalues", co2Data.methaneAnalog);
  json.add("timestamp_unix", co2Data.timestamp);

  if (Firebase.RTDB.setJSON(&fbdo, path.c_str(), &json)) {
    Serial.println("✅ Data terkirim ke Firebase");
    statusFirebase = "FB: OK";
  } else {
    Serial.print("❌ Gagal kirim: ");
    Serial.println(fbdo.errorReason());
    statusFirebase = "FB: ERR";
  }
}

void setup() {
  Serial.begin(115200);
  Serial.println("Loading Gan!!");

  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("❌ Gagal inisialisasi OLED");
    while (1);
  }
  display.clearDisplay();
  display.display();

  WiFi.disconnect(true);
  delay(1000);
  WiFi.mode(WIFI_STA);
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("🔌 Menghubungkan ke WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500); Serial.print(".");
  }
  Serial.println("\n📶 WiFi terhubung!");
  Serial.print("📡 IP: "); Serial.println(WiFi.localIP());

  initESPNow();

  configTime(7 * 3600, 0, "pool.ntp.org");
  Serial.println("⏳ Sinkronisasi waktu...");
  while (time(nullptr) < 7 * 3600) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\n✅ Waktu tersinkron!");

  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;
  config.time_zone = 7;

  auth.user.email = USER_EMAIL;
  auth.user.password = USER_PASSWORD;

  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  while (auth.token.uid.length() == 0) {
    Serial.print(".");
    delay(500);
  }
  Serial.println("\n✅ Firebase siap!");

  mySerial.begin(BAUDRATE, SERIAL_8N1, RX_PIN, TX_PIN);
  myMHZ19.begin(mySerial);
  myMHZ19.autoCalibration();
  dht1.begin();
}

unsigned long previousMillisFirebase = 0;
unsigned long previousMillisESPNow = 0;
const long intervalFirebase = 30000;
const long intervalESPNow = 60000;

bool useSimulatedData = true; // Ganti ke false kalau sensor udah dipasang

void loop() {
  unsigned long currentMillis = millis();

  if (currentMillis - previousMillisFirebase >= intervalFirebase) {
    previousMillisFirebase = currentMillis;

    if (useSimulatedData) {
      // ====== DATA SIMULASI ======
      co2Data.co2 = random(400, 1000); // 400–1000 ppm CO2
      co2Data.temperature = random(200, 350) / 10.0; // 20.0 – 35.0 °C
      co2Data.humidity = random(400, 800) / 10.0; // 40.0 – 80.0 %
      co2Data.methane = random(0, 50); // Methane PPM dummy
      co2Data.methaneAnalog = random(0, 4096); // Simulasi analog MQ-4
      co2Data.timestamp = time(nullptr);
    } else {
      // ====== DATA SENSOR SEBENARNYA ======
      co2Data.co2 = myMHZ19.getCO2();
      co2Data.temperature = dht1.readTemperature();
      co2Data.humidity = dht1.readHumidity();
      co2Data.methane = getMethanePPM();
      co2Data.methaneAnalog = analogRead(MQ4_Pin);
      co2Data.timestamp = time(nullptr);
    }

    showOLED();
    uploadToFirebase();
  }

  if (currentMillis - previousMillisESPNow >= intervalESPNow) {
    previousMillisESPNow = currentMillis;
    sendData1(co2Data.co2, co2Data.methane, co2Data.temperature, co2Data.humidity, co2Data.methaneAnalog);
  }
}

