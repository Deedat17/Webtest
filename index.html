<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CO2 Monitoring Dashboard</title>
  <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/1/19/Carbon_dioxide_icon.png" />
  
  <!-- Firebase & Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Styles -->
  <style>
    :root {
      --primary: #4361ee;
      --success: #06d6a0;
      --warning: #ffd166;
      --danger: #ef476f;
      --dark: #2b2d42;
      --light: #f8f9fa;
      --bg: #f0f2f5;
      --card: #ffffff;
      --text: #2b2d42;
      --border-radius: 12px;
      --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      transition: var(--transition);
    }

    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background: var(--card);
      box-shadow: var(--box-shadow);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: var(--border-radius);
      margin-bottom: 30px;
    }

    h1 {
      font-size: 28px;
      font-weight: 600;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1 i {
      font-size: 28px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      justify-content: space-between;
      background: var(--card);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 30px;
    }

    .date-controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .control-group label {
      font-size: 14px;
      font-weight: 500;
      color: var(--dark);
    }
    
    input[type="date"] {
      padding: 10px 15px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: var(--transition);
    }
    
    input[type="date"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }
    
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
    }
    
    button:hover {
      background: #3a51ca;
      transform: translateY(-2px);
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }
    
    .stat-card {
      background: var(--card);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card h3 {
      font-size: 16px;
      font-weight: 500;
      color: #6c757d;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .current-reading {
      font-size: 32px;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 10px;
    }
    
    .chart-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }
    
    @media (max-width: 768px) {
      .chart-container {
        grid-template-columns: 1fr;
      }
    }
    
    .chart-box {
      background: var(--card);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 20px;
      transition: var(--transition);
      position: relative;
    }
    
    .chart-box:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    canvas {
      width: 100% !important;
      height: 300px !important;
    }
    
    .table-section {
      background: var(--card);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 20px;
      margin-bottom: 40px;
      overflow: hidden;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .table-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .table-wrapper {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th {
      background-color: #f6f9fc;
      color: var(--dark);
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    
    tr:hover {
      background-color: #f6f9fc;
    }
    
    .alert-threshold {
      color: var(--danger);
      font-weight: 600;
    }
    
    .footer {
      text-align: center;
      margin-top: 40px;
      padding-bottom: 20px;
      font-size: 14px;
      color: #6c757d;
    }
    
    /* Responsive adjustments */
    @media (max-width: 992px) {
      .dashboard-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .controls {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .date-controls {
        width: 100%;
        flex-direction: column;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      input[type="date"], button {
        width: 100%;
      }
    }

    /* Loading spinner */
    .loader {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-left-color: var(--primary);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Alert styling */
    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--danger);
      color: white;
      padding: 15px 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }
    
    .alert.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .alert i {
      font-size: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-leaf"></i> CO2 Monitoring Dashboard</h1>
      <div id="last-updated">Memuat data...</div>
    </header>
    
    <div class="controls">
      <div class="date-controls">
        <div class="control-group">
          <label for="start-date">Tanggal Mulai</label>
          <input type="date" id="start-date">
        </div>
        <div class="control-group">
          <label for="end-date">Tanggal Akhir</label>
          <input type="date" id="end-date">
        </div>
      </div>
      <button onclick="exportToCSV()"><i class="fas fa-download"></i> Ekspor CSV</button>
    </div>
    
    <div class="dashboard-grid">
      <div class="stat-card">
        <h3><i class="fas fa-wind"></i> CO2</h3>
        <div id="current-co2" class="current-reading">-</div>
        <div id="co2-trend"></div>
      </div>
      <div class="stat-card">
        <h3><i class="fas fa-temperature-high"></i> Suhu</h3>
        <div id="current-temp" class="current-reading">-</div>
        <div id="temp-trend"></div>
      </div>
      <div class="stat-card">
        <h3><i class="fas fa-tint"></i> Kelembaban</h3>
        <div id="current-humidity" class="current-reading">-</div>
        <div id="humidity-trend"></div>
      </div>
      <div class="stat-card">
        <h3><i class="fas fa-fire-alt"></i> Metana</h3>
        <div id="current-methane" class="current-reading">-</div>
        <div id="methane-trend"></div>
      </div>
    </div>
    
    <div class="chart-container">
      <div class="chart-box">
        <div class="chart-title"><i class="fas fa-wind"></i> CO2 (ppm)</div>
        <canvas id="co2Chart"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-title"><i class="fas fa-temperature-high"></i> Suhu (°C)</div>
        <canvas id="tempChart"></canvas>
      </div>
    </div>
    
    <div class="chart-container">
      <div class="chart-box">
        <div class="chart-title"><i class="fas fa-tint"></i> Kelembaban (%)</div>
        <canvas id="humidityChart"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-title"><i class="fas fa-fire-alt"></i> Metana (ppm)</div>
        <canvas id="methaneChart"></canvas>
      </div>
    </div>
    
    <div class="table-section">
      <div class="table-header">
        <div class="table-title"><i class="fas fa-table"></i> Data Pengukuran</div>
        <div id="data-count">0 catatan</div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Waktu</th>
              <th>CO2 (ppm)</th>
              <th>Suhu (°C)</th>
              <th>Kelembaban (%)</th>
              <th>Metana (ppm)</th>
              <th>Analog CH4</th>
            </tr>
          </thead>
          <tbody id="data-table">
            <tr>
              <td colspan="6">
                <div class="loader">
                  <div class="spinner"></div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="footer">
      &copy; 2025 CO2 Monitoring System - Pemantauan lingkungan real-time
    </div>
  </div>
  
  <div class="alert" id="alert">
    <i class="fas fa-exclamation-triangle"></i>
    <span id="alert-message"></span>
  </div>
  
  <audio id="alertSound" src="https://www.soundjay.com/button/beep-07.wav"></audio>

  <script>
    // Firebase initialization
    const firebaseConfig = {
      apiKey: "AIzaSyB_Az8o_NvqVSWezD9agZ4Hrj8RAxXFlCY",
      authDomain: "decompose-5702c.firebaseapp.com",
      databaseURL: "https://decompose-5702c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "decompose-5702c",
      storageBucket: "decompose-5702c.appspot.com",
      messagingSenderId: "195684972273",
      appId: "1:195684972273:web:93763c0dbc2e46cbe2db50",
      measurementId: "G-42G22XTDJH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('AllData/CO2');
    
    // Initialize charts with better options
    const chartOptions = {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(255, 255, 255, 0.9)',
          titleColor: '#2b2d42',
          bodyColor: '#2b2d42',
          borderColor: '#e0e0e0',
          borderWidth: 1,
          padding: 10,
          cornerRadius: 8,
          displayColors: false,
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + context.raw;
            }
          }
        }
      },
      scales: {
        x: {
          grid: {
            display: false
          },
          ticks: {
            autoSkip: true,
            maxTicksLimit: 8,
            maxRotation: 0
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          },
          ticks: {
            precision: 0
          }
        }
      },
      elements: {
        line: {
          tension: 0.4
        },
        point: {
          radius: 0,
          hitRadius: 10,
          hoverRadius: 5
        }
      }
    };
    
    // Create charts with improved styling
    const charts = {
      co2: createChart('co2Chart', 'CO2 (ppm)', '#4361ee'),
      temp: createChart('tempChart', 'Suhu (°C)', '#06d6a0'),
      humidity: createChart('humidityChart', 'Kelembaban (%)', '#ffd166'),
      methane: createChart('methaneChart', 'Metana (ppm)', '#ef476f')
    };
    
    function createChart(id, label, color) {
      const options = JSON.parse(JSON.stringify(chartOptions)); // Clone options
      return new Chart(document.getElementById(id), {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label,
            data: [],
            borderColor: color,
            backgroundColor: hexToRgba(color, 0.2),
            fill: true,
            borderWidth: 2
          }]
        },
        options: options
      });
    }
    
    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    
    // Show alert function
    function showAlert(message) {
      const alert = document.getElementById('alert');
      const alertMessage = document.getElementById('alert-message');
      alertMessage.textContent = message;
      alert.classList.add('show');
      
      // Play sound
      document.getElementById('alertSound').play();
      
      // Hide after 5 seconds
      setTimeout(() => {
        alert.classList.remove('show');
      }, 5000);
    }
    
    // Process and display data
    function updateChartsAndTable(data) {
      const tbody = document.getElementById('data-table');
      tbody.innerHTML = '';
      
      let labels = [], co2 = [], temp = [], humidity = [], methane = [], csv = [];
      let latestCO2 = 0, latestTemp = 0, latestHumidity = 0, latestMethane = 0;
      let latestTimestamp = '';
      
      // Get sorted keys (timestamps)
      const keys = Object.keys(data).sort();
      document.getElementById('data-count').textContent = `${keys.length} catatan`;
      
      // No data case
      if (keys.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Tidak ada data untuk periode yang dipilih</td></tr>';
        return;
      }
      
      // Process data
      keys.forEach(ts => {
        const e = data[ts];
        if (!e) return;
        
        // Format the timestamp more readably
        const date = new Date(ts);
        const formattedDate = date.toLocaleString('id-ID', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const shortLabel = formattedDate.split(', ')[1]; // Just time for charts
        
        // Push data to arrays
        labels.push(shortLabel);
        co2.push(e.CO2 ?? 0);
        temp.push(e.temperature ?? 0);
        humidity.push(e.humidity ?? 0);
        methane.push(e.methane ?? 0);
        
        // Check for latest values
        if (ts === keys[keys.length - 1]) {
          latestCO2 = e.CO2 ?? 0;
          latestTemp = e.temperature ?? 0;
          latestHumidity = e.humidity ?? 0;
          latestMethane = e.methane ?? 0;
          latestTimestamp = formattedDate;
        }
        
        // Create table row with better formatting
        const highCO2 = (e.CO2 > 1000) ? 'alert-threshold' : '';
        const highMethane = (e.methane > 1000) ? 'alert-threshold' : '';
        
        const row = `
          <tr>
            <td>${formattedDate}</td>
            <td class="${highCO2}">${e.CO2 ?? 'N/A'}</td>
            <td>${e.temperature ?? 'N/A'}</td>
            <td>${e.humidity ?? 'N/A'}</td>
            <td class="${highMethane}">${e.methane ?? 'N/A'}</td>
            <td>${e.analogvalues ?? 'N/A'}</td>
          </tr>
        `;
        tbody.innerHTML += row;
        
        // Save CSV data
        csv.push([ts, e.CO2, e.temperature, e.humidity, e.methane, e.analogvalues]);
        
        // Check alert conditions
        if (e.CO2 > 1000 || e.methane > 1000) {
          if (e.CO2 > 1000 && e.methane > 1000) {
            showAlert('Peringatan! Kadar CO2 dan Metana melebihi ambang batas!');
          } else if (e.CO2 > 1000) {
            showAlert('Peringatan! Kadar CO2 melebihi ambang batas!');
          } else {
            showAlert('Peringatan! Kadar Metana melebihi ambang batas!');
          }
        }
      });
      
      // Update current readings
      document.getElementById('current-co2').textContent = `${latestCO2} ppm`;
      document.getElementById('current-temp').textContent = `${latestTemp} °C`;
      document.getElementById('current-humidity').textContent = `${latestHumidity} %`;
      document.getElementById('current-methane').textContent = `${latestMethane} ppm`;
      document.getElementById('last-updated').textContent = `Terakhir diperbarui: ${latestTimestamp}`;
      
      // Update trends (simple)
      updateTrend('co2-trend', co2);
      updateTrend('temp-trend', temp);
      updateTrend('humidity-trend', humidity);
      updateTrend('methane-trend', methane);
      
      // Update charts
      charts.co2.data.labels = labels;
      charts.temp.data.labels = labels;
      charts.humidity.data.labels = labels;
      charts.methane.data.labels = labels;
      
      charts.co2.data.datasets[0].data = co2;
      charts.temp.data.datasets[0].data = temp;
      charts.humidity.data.datasets[0].data = humidity;
      charts.methane.data.datasets[0].data = methane;
      
      // Update charts efficiently
      Object.values(charts).forEach(chart => chart.update('none')); // Use 'none' mode for better performance
      
      // Store CSV data for export
      window.csvData = csv;
    }
    
    // Update trend indicators
    function updateTrend(elementId, data) {
      if (data.length < 2) return;
      
      const element = document.getElementById(elementId);
      const lastValue = data[data.length - 1];
      const prevValue = data[data.length - 2];
      
      if (lastValue > prevValue) {
        element.innerHTML = '<span style="color: #ef476f;"><i class="fas fa-arrow-up"></i> Naik</span>';
      } else if (lastValue < prevValue) {
        element.innerHTML = '<span style="color: #06d6a0;"><i class="fas fa-arrow-down"></i> Turun</span>';
      } else {
        element.innerHTML = '<span style="color: #ffd166;"><i class="fas fa-equals"></i> Stabil</span>';
      }
    }
    
    // Export data to CSV
    function exportToCSV() {
      if (!window.csvData || window.csvData.length === 0) {
        showAlert('Tidak ada data untuk diekspor');
        return;
      }
      
      let csvContent = "Timestamp,CO2,Temperature,Humidity,Methane,AnalogCH4\n";
      window.csvData.forEach(row => {
        csvContent += row.join(",") + "\n";
      });
      
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      saveAs(blob, `data-export-${new Date().toISOString().slice(0,10)}.csv`);
    }
    
    // Set default date range (last 7 days)
    function setDefaultDateRange() {
      const end = new Date();
      const start = new Date();
      start.setDate(start.getDate() - 7);
      
      document.getElementById('start-date').value = start.toISOString().slice(0, 10);
      document.getElementById('end-date').value = end.toISOString().slice(0, 10);
    }
    
    // Fetch data with optimization
    function fetchData() {
      const tbody = document.getElementById('data-table');
      tbody.innerHTML = '<tr><td colspan="6"><div class="loader"><div class="spinner"></div></div></td></tr>';
      
      db.once('value')
        .then(snap => {
          const data = snap.val();
          if (!data) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Tidak ada data tersedia</td></tr>';
            return;
          }
          
          const start = document.getElementById('start-date').value;
          const end = document.getElementById('end-date').value;
          const filtered = {};
          
          // Add one day to end date for inclusive range
          let endDate = new Date(end);
          if (end) {
            endDate.setDate(endDate.getDate() + 1);
            const endStr = endDate.toISOString().split('T')[0];
            
            Object.keys(data).forEach(key => {
              if ((!start || key >= start) && (!end || key < endStr)) {
                filtered[key] = data[key];
              }
            });
          } else {
            Object.keys(data).forEach(key => {
              if (!start || key >= start) {
                filtered[key] = data[key];
              }
            });
          }
          
          updateChartsAndTable(filtered);
        })
        .catch(error => {
          tbody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Error: ${error.message}</td></tr>`;
          console.error("Firebase data error:", error);
        });
    }
    
    // Event listeners
    document.getElementById('start-date').addEventListener('change', fetchData);
    document.getElementById('end-date').addEventListener('change', fetchData);
    
    // Initialize
    setDefaultDateRange();
    fetchData();
    
    // Add responsive behavior for mobile
    function adjustForMobile() {
      if (window.innerWidth < 768) {
        Object.values(charts).forEach(chart => {
          chart.options.scales.x.ticks.maxTicksLimit = 5;
          chart.update('none');
        });
      }
    }
    
    // Check on load and resize
    window.addEventListener('resize', adjustForMobile);
    adjustForMobile();
  </script>
</body>
</html>
