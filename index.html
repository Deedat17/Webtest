<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CO2 Monitoring Dashboard</title>
  <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/1/19/Carbon_dioxide_icon.png" />

  <!-- Firebase & Libraries - Load only what's needed -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- Inline critical CSS for faster loading -->
  <style>
    :root {
      --primary: #3a86ff;
      --secondary: #8338ec;
      --success: #38b000;
      --warning: #ffbe0b;
      --danger: #ff006e;
      --dark: #222222;
      --light: #f5f5f5;
      --card-bg: #ffffff;
      --gradient-bg: #f5f5f5;
    }
  
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
  
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--gradient-bg);
      color: var(--dark);
      min-height: 100vh;
      padding: 20px;
    }
  
    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 28px;
      font-weight: 600;
      color: var(--dark);
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
  
    h1::before,
    h1::after {
      content: '';
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--primary), transparent);
      flex: 1;
      max-width: 100px;
    }
  
    .dashboard {
      max-width: 1400px;
      margin: 0 auto;
    }
  
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      background: #ffffff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
  
    .controls label {
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--dark);
    }
  
    .controls input {
      padding: 8px 12px;
      font-size: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      color: var(--dark);
      font-family: 'Poppins', sans-serif;
    }
  
    .btn {
      padding: 8px 16px;
      font-size: 15px;
      border-radius: 6px;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Poppins', sans-serif;
      font-weight: 400;
      display: flex;
      align-items: center;
      gap: 6px;
    }
  
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
  
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
  
    .btn-export {
      background: var(--secondary);
    }
  
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
  
    .chart-card {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s;
    }
  
    .chart-card:hover {
      transform: translateY(-5px);
    }
  
    .chart-header {
      padding: 15px;
      border-bottom: 1px solid #eee;
      background: #fafafa;
    }
  
    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--dark);
    }
  
    .chart-body {
      padding: 10px;
      height: 250px;
      position: relative;
    }
  
    .table-section {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      margin-top: 20px;
    }
  
    .table-header {
      padding: 15px;
      border-bottom: 1px solid #eee;
      background: #fafafa;
    }
  
    .table-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
    }
  
    .data-table-wrapper {
      overflow-x: auto;
      padding: 0 5px;
    }
  
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
  
    th,
    td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #eee;
      color: var(--dark);
    }
  
    th {
      background-color: #f2f2f2;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
  
    tr:hover {
      background-color: #f8f8f8;
    }
  
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: #ffffff;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
  
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--dark);
    }
  
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: var(--success);
    }
  
    .status-indicator.loading {
      background-color: var(--warning);
      animation: pulse 1.5s infinite;
    }
  
    #loading-indicator,
    #alert-message {
      color: var(--dark);
      font-weight: 500;
      min-height: 20px;
    }
  
    @keyframes pulse {
      0% {
        opacity: 1;
      }
  
      50% {
        opacity: 0.5;
      }
  
      100% {
        opacity: 1;
      }
    }
  
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
  
    .stat-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }
  
    .stat-title {
      font-size: 14px;
      color: #555;
      margin-bottom: 5px;
    }
  
    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: var(--dark);
    }
  
    .stat-footer {
      margin-top: 10px;
      font-size: 12px;
      color: #888;
      display: flex;
      align-items: center;
      gap: 5px;
    }
  
    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
  
      .stats-row {
        grid-template-columns: repeat(2, 1fr);
      }
  
      .btn span {
        display: none;
      }
    }
  </style>
  
</head>
<body>
  <div class="dashboard">
    <div class="dashboard-header">
      <h1>CO2 Monitoring Dashboard</h1>
    </div>
    
    <div class="status-bar">
      <div class="status-item">
        <div id="status-indicator" class="status-indicator"></div>
        <div id="loading-indicator"></div>
      </div>
      <div id="alert-message"></div>
      <div class="status-item">
        <i class="bi bi-clock"></i>
        <div id="last-update">Last update: Never</div>
      </div>
    </div>
    
    <div class="controls">
      <label><i class="bi bi-calendar3"></i> From: <input type="date" id="start-date"></label>
      <label><i class="bi bi-calendar3"></i> To: <input type="date" id="end-date"></label>
      <button id="refresh-btn" class="btn"><i class="bi bi-arrow-clockwise"></i> <span>Refresh</span></button>
      <button id="export-btn" class="btn btn-export"><i class="bi bi-download"></i> <span>Export CSV</span></button>
    </div>
    
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-title">CO2 Level (Latest)</div>
        <div id="co2-latest" class="stat-value">-- ppm</div>
        <div class="stat-footer">
          <i class="bi bi-arrow-up"></i>
          <span id="co2-change">--</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Temperature (Latest)</div>
        <div id="temp-latest" class="stat-value">-- Â°C</div>
        <div class="stat-footer">
          <i class="bi bi-arrow-down"></i>
          <span id="temp-change">--</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Humidity (Latest)</div>
        <div id="humidity-latest" class="stat-value">-- %</div>
        <div class="stat-footer">
          <i class="bi bi-arrow-up"></i>
          <span id="humidity-change">--</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Methane (Latest)</div>
        <div id="methane-latest" class="stat-value">-- ppm</div>
        <div class="stat-footer">
          <i class="bi bi-arrow-up"></i>
          <span id="methane-change">--</span>
        </div>
      </div>
    </div>
    
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title"><i class="bi bi-cloud-fill"></i> CO2 Level</div>
        </div>
        <div class="chart-body">
          <canvas id="co2Chart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title"><i class="bi bi-thermometer-half"></i> Temperature</div>
        </div>
        <div class="chart-body">
          <canvas id="tempChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title"><i class="bi bi-droplet-fill"></i> Humidity</div>
        </div>
        <div class="chart-body">
          <canvas id="humidityChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title"><i class="bi bi-fuel-pump-fill"></i> Methane</div>
        </div>
        <div class="chart-body">
          <canvas id="methaneChart"></canvas>
        </div>
      </div>
    </div>
    
    <div class="table-section">
      <div class="table-header">
        <div class="table-title"><i class="bi bi-table"></i> Data Records</div>
        <div id="records-count">0 records</div>
      </div>
      <div class="data-table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>CO2 (ppm)</th>
              <th>Temperature (Â°C)</th>
              <th>Humidity (%)</th>
              <th>Methane (ppm)</th>
              <th>Analog CH4</th>
            </tr>
          </thead>
          <tbody id="data-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB_Az8o_NvqVSWezD9agZ4Hrj8RAxXFlCY",
      authDomain: "decompose-5702c.firebaseapp.com",
      databaseURL: "https://decompose-5702c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "decompose-5702c",
      storageBucket: "decompose-5702c.appspot.com",
      messagingSenderId: "195684972273",
      appId: "1:195684972273:web:93763c0dbc2e46cbe2db50",
      measurementId: "G-42G22XTDJH"
    };
    
    // Global variables
    let dbRef = null;
    let charts = {};
    let csvData = [];
    
    // App state
    const appState = {
      lastFetch: null,
      isLoading: false,
      lastData: null
    };
    
    // Initialize Firebase
    function initFirebase() {
      firebase.initializeApp(firebaseConfig);
      dbRef = firebase.database().ref('AllData/CO2');
    }
    
    // Create a chart with optimized options
    function createChart(id, label, color) {
      const ctx = document.getElementById(id).getContext('2d');
      
      // Create gradient background
      const gradient = ctx.createLinearGradient(0, 0, 0, 250);
      gradient.addColorStop(0, color + '33');
      gradient.addColorStop(1, color + '03');
      
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label,
            data: [],
            borderColor: color,
            backgroundColor: gradient,
            borderWidth: 2,
            tension: 0.4,
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 5,
            pointHoverBackgroundColor: color,
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 0 // Disable animations for better performance
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(26, 27, 37, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgba(255, 255, 255, 0.1)',
              borderWidth: 1,
              padding: 10,
              displayColors: false,
              callbacks: {
                title: function(tooltipItems) {
                  return tooltipItems[0].label;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(0,0,0,0.05)',
                drawBorder: false
              },
              ticks: {
                maxTicksLimit: 8,
                color: 'rgba(0,0,0,0.6)',
                font: {
                  size: 10
                }
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0,0,0,0.05)',
                drawBorder: false
              },
              ticks: {
                color: 'rgba(0,0,0,0.6)',
                font: {
                  size: 10
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
    }
    
    // Initialize charts
    function initCharts() {
      charts = {
        co2: createChart('co2Chart', 'CO2 (ppm)', '#3a86ff'),
        temp: createChart('tempChart', 'Temperature (Â°C)', '#38b000'),
        humidity: createChart('humidityChart', 'Humidity (%)', '#ffbe0b'),
        methane: createChart('methaneChart', 'Methane (ppm)', '#ff006e')
      };
    }
    
    // Show/hide loading indicator
    function setLoading(isLoading) {
      appState.isLoading = isLoading;
      const statusIndicator = document.getElementById('status-indicator');
      const loadingIndicator = document.getElementById('loading-indicator');
      
      if (isLoading) {
        statusIndicator.classList.add('loading');
        loadingIndicator.textContent = 'Fetching data...';
      } else {
        statusIndicator.classList.remove('loading');
        loadingIndicator.textContent = 'Connected';
      }
      
      // Also disable refresh button while loading
      document.getElementById('refresh-btn').disabled = isLoading;
    }
    
    // Show alert message
    function showAlert(message, autoHide = true) {
      const alertEl = document.getElementById('alert-message');
      alertEl.textContent = message;
      
      if (autoHide) {
        setTimeout(() => {
          alertEl.textContent = '';
        }, 3000);
      }
    }
    
    // Update last refresh time
    function updateLastRefresh() {
      const now = new Date();
      const options = { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      };
      document.getElementById('last-update').textContent = 
        'Last update: ' + now.toLocaleDateString('en-US', options);
    }
    
    // Fetch data from Firebase
    function fetchData() {
      // Prevent multiple fetches
      if (appState.isLoading) return;
      
      setLoading(true);
      
      // Get date filters
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      
      // Fetch once from Firebase
      dbRef.once('value')
        .then(snapshot => {
          const data = snapshot.val();
          
          if (!data) {
            setLoading(false);
            showAlert('No data available');
            return;
          }
          
          // Filter by date if needed
          const filtered = {};
          Object.keys(data).forEach(key => {
            if ((!startDate || key >= startDate) && (!endDate || key <= endDate + 'T23:59:59')) {
              filtered[key] = data[key];
            }
          });
          
          appState.lastFetch = new Date();
          appState.lastData = filtered;
          
          // Process and update UI
          processData(filtered);
          setLoading(false);
          updateLastRefresh();
        })
        .catch(error => {
          console.error('Error fetching data:', error);
          setLoading(false);
          showAlert('Failed to fetch data: ' + error.message);
        });
    }
    
    // Update stats cards
    function updateStats(data) {
      if (!data || Object.keys(data).length === 0) return;
      
      // Get latest data point
      const sortedKeys = Object.keys(data).sort();
      const latestKey = sortedKeys[sortedKeys.length - 1];
      const latestData = data[latestKey];
      
      // Get previous data point (for change calculation)
      const prevKey = sortedKeys.length > 1 ? sortedKeys[sortedKeys.length - 2] : null;
      const prevData = prevKey ? data[prevKey] : null;
      
      // Update stat cards
      document.getElementById('co2-latest').textContent = 
        (latestData.CO2 !== undefined ? latestData.CO2 : '--') + ' ppm';
      
      document.getElementById('temp-latest').textContent = 
        (latestData.temperature !== undefined ? latestData.temperature : '--') + ' Â°C';
      
      document.getElementById('humidity-latest').textContent = 
        (latestData.humidity !== undefined ? latestData.humidity : '--') + ' %';
      
      document.getElementById('methane-latest').textContent = 
        (latestData.methane !== undefined ? latestData.methane : '--') + ' ppm';
      
      // Calculate changes if we have previous data
      if (prevData) {
        // CO2 change
        const co2Change = latestData.CO2 - prevData.CO2;
        const co2Element = document.getElementById('co2-change');
        co2Element.textContent = Math.abs(co2Change).toFixed(2) + ' ppm';
        co2Element.previousElementSibling.className = 
          co2Change >= 0 ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
        
        // Temperature change
        const tempChange = latestData.temperature - prevData.temperature;
        const tempElement = document.getElementById('temp-change');
        tempElement.textContent = Math.abs(tempChange).toFixed(2) + ' Â°C';
        tempElement.previousElementSibling.className = 
          tempChange >= 0 ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
        
        // Humidity change
        const humidityChange = latestData.humidity - prevData.humidity;
        const humidityElement = document.getElementById('humidity-change');
        humidityElement.textContent = Math.abs(humidityChange).toFixed(2) + ' %';
        humidityElement.previousElementSibling.className = 
          humidityChange >= 0 ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
        
        // Methane change
        const methaneChange = latestData.methane - prevData.methane;
        const methaneElement = document.getElementById('methane-change');
        methaneElement.textContent = Math.abs(methaneChange).toFixed(2) + ' ppm';
        methaneElement.previousElementSibling.className = 
          methaneChange >= 0 ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
      }
    }
    
    // Process data and update UI
    function processData(data) {
      // Prepare data
      let labels = [], co2 = [], temp = [], humidity = [], methane = [];
      csvData = []; // Reset CSV data
      
      // Get sorted keys for consistent ordering
      const keys = Object.keys(data).sort();
      
      // Quick check if we have too many data points
      const dataCount = keys.length;
      if (dataCount === 0) {
        showAlert('No data available for the selected date range');
        document.getElementById('records-count').textContent = '0 records';
        return;
      }
      
      // For very large datasets, sample the data
      const sampleRate = dataCount > 1000 ? Math.ceil(dataCount / 1000) : 1;
      
      // Batch DOM operations for table
      const tbody = document.getElementById('data-table');
      tbody.innerHTML = ''; // Clear table
      
      // Create document fragment for better performance
      const fragment = document.createDocumentFragment();
      
      // Process data points
      keys.forEach((ts, index) => {
        // Skip for large datasets based on sample rate for charts
        const isChartPoint = sampleRate === 1 || index % sampleRate === 0 || index === keys.length - 1;
        
        const e = data[ts];
        if (!e) return;
        
        // Format timestamp for display
        const shortLabel = ts.replace('T', ' ').slice(5, 16);
        
        // Add to chart data if it's a chart point
        if (isChartPoint) {
          labels.push(shortLabel);
          co2.push(e.CO2 ?? 0);
          temp.push(e.temperature ?? 0);
          humidity.push(e.humidity ?? 0);
          methane.push(e.methane ?? 0);
        }
        
        // Add to CSV data
        csvData.push([ts, e.CO2, e.temperature, e.humidity, e.methane, e.analogvalues]);
        
        // For really large datasets, don't show every point in the table
        if (dataCount > 200 && index % Math.ceil(dataCount / 200) !== 0 && index !== keys.length - 1) {
          return;
        }
        
        // Create table row
        const row = document.createElement('tr');
        
        // Add cells
        [
          ts,
          e.CO2 ?? 'N/A',
          e.temperature ?? 'N/A',
          e.humidity ?? 'N/A',
          e.methane ?? 'N/A',
          e.analogvalues ?? 'N/A'
        ].forEach(value => {
          const cell = document.createElement('td');
          cell.textContent = value;
          row.appendChild(cell);
        });
        
        fragment.appendChild(row);
      });
      
      // Add all rows at once
      tbody.appendChild(fragment);
      
      // Update chart data all at once
      charts.co2.data.labels = 
      charts.temp.data.labels = 
      charts.humidity.data.labels = 
      charts.methane.data.labels = labels;
      
      charts.co2.data.datasets[0].data = co2;
      charts.temp.data.datasets[0].data = temp;
      charts.humidity.data.datasets[0].data = humidity;
      charts.methane.data.datasets[0].data = methane;
      
      // Update all charts without animations
      Object.values(charts).forEach(chart => chart.update(0));
      
      // Update stats
      updateStats(data);
      
      // Update record counter
      document.getElementById('records-count').textContent = `${dataCount} records found`;
    }
    // Show/hide loading indicator
    function setLoading(isLoading) {
      appState.isLoading = isLoading;
      const statusIndicator = document.getElementById('status-indicator');
      const loadingIndicator = document.getElementById('loading-indicator');
      
      if (isLoading) {
        statusIndicator.classList.add('loading');
        loadingIndicator.textContent = 'Fetching data...';
      } else {
        statusIndicator.classList.remove('loading');
        loadingIndicator.textContent = 'Connected';
      }
      
      // Also disable refresh button while loading
      document.getElementById('refresh-btn').disabled = isLoading;
    }
    
    // Show alert message
    function showAlert(message, autoHide = true) {
      const alertEl = document.getElementById('alert-message');
      alertEl.textContent = message;
      
      if (autoHide) {
        setTimeout(() => {
          alertEl.textContent = '';
        }, 3000);
      }
    }
    
    // Update last refresh time
    function updateLastRefresh() {
      const now = new Date();
      const options = { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      };
      document.getElementById('last-update').textContent = 
        'Last update: ' + now.toLocaleDateString('en-US', options);
    }
    
    // Fetch data from Firebase
    function fetchData() {
      // Prevent multiple fetches
      if (appState.isLoading) return;
      
      setLoading(true);
      
      // Get date filters
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      
      // Fetch once from Firebase
      dbRef.once('value')
        .then(snapshot => {
          const data = snapshot.val();
          
          if (!data) {
            setLoading(false);
            showAlert('No data available');
            return;
          }
          
          // Filter by date if needed
          const filtered = {};
          Object.keys(data).forEach(key => {
            if ((!startDate || key >= startDate) && (!endDate || key <= endDate + 'T23:59:59')) {
              filtered[key] = data[key];
            }
          });
          
          appState.lastFetch = new Date();
          appState.lastData = filtered;
          
          // Process and update UI
          processData(filtered);
          setLoading(false);
          updateLastRefresh();
        })
        .catch(error => {
          console.error('Error fetching data:', error);
          setLoading(false);
          showAlert('Failed to fetch data: ' + error.message);
        });
    }
    
    // Update stats cards
    function updateStats(data) {
      if (!data || Object.keys(data).length === 0) return;
      
      // Get latest data point
      const sortedKeys = Object.keys(data).sort();
      const latestKey = sortedKeys[sortedKeys.length - 1];
      const latestData = data[latestKey];
      
      // Get previous data point (for change calculation)
      const prevKey = sortedKeys.length > 1 ? sortedKeys[sortedKeys.length - 2] : null;
      const prevData = prevKey ? data[prevKey] : null;
      
      // Update stat cards
      document.getElementById('co2-latest').textContent = 
        (latestData.CO2 !== undefined ? latestData.CO2 : '--') + ' ppm';
      
      document.getElementById('temp-latest').textContent = 
        (latestData.temperature !== undefined ? latestData.temperature : '--') + ' Â°C';
      
      document.getElementById('humidity-latest').textContent = 
        (latestData.humidity !== undefined ? latestData.humidity : '--') + ' %';
      
      document.getElementById('methane-latest').textContent = 
        (latestData.methane !== undefined ? latestData.methane : '--') + ' ppm';
      
      // Calculate changes if we have previous data
      if (prevData) {
        // CO2 change
        const co2Change = latestData.CO2 - prevData.CO2;
        const co2Element = document.getElementById('co2-change');
        co2Element.textContent = Math.abs(co2Change).toFixed(2) + ' ppm';
        co2Element.previousElementSibling.className = 
          co2Change >= 0 ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
        
        // Temperature change
        const tempChange = latestData.temperature - prevData.temperature;
        const tempElement = document.getElementById('temp-change');
        tempElement.textContent = Math.abs(tempChange).toFixed(2) + ' Â°C';
        tempElement.previousElementSibling.className = 
          tempChange >= 0 ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
        
        // Humidity change
        const humidityChange = latestData.humidity - prevData.humidity;
        const humidityElement = document.getElementById('humidity-change');
        humidityElement.textContent = Math.abs(humidityChange).toFixed(2) + ' %';
        humidityElement.previousElementSibling.className = 
          humidityChange >= 0 ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
        
        // Methane change
        const methaneChange = latestData.methane - prevData.methane;
        const methaneElement = document.getElementById('methane-change');
        methaneElement.textContent = Math.abs(methaneChange).toFixed(2) + ' ppm';
        methaneElement.previousElementSibling.className = 
          methaneChange >= 0 ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
      }
    }
    
    // Process data and update UI
    function processData(data) {
      // Prepare data
      let labels = [], co2 = [], temp = [], humidity = [], methane = [];
      csvData = []; // Reset CSV data
      
      // Get sorted keys for consistent ordering
      const keys = Object.keys(data).sort();
      
      // Quick check if we have too many data points
      const dataCount = keys.length;
      if (dataCount === 0) {
        showAlert('No data available for the selected date range');
        document.getElementById('records-count').textContent = '0 records';
        return;
      }
      
      // For very large datasets, sample the data
      const sampleRate = dataCount > 1000 ? Math.ceil(dataCount / 1000) : 1;
      
      // Batch DOM operations for table
      const tbody = document.getElementById('data-table');
      tbody.innerHTML = ''; // Clear table
      
      // Create document fragment for better performance
      const fragment = document.createDocumentFragment();
      
      // Process data points
      keys.forEach((ts, index) => {
        // Skip for large datasets based on sample rate for charts
        const isChartPoint = sampleRate === 1 || index % sampleRate === 0 || index === keys.length - 1;
        
        const e = data[ts];
        if (!e) return;
        
        // Format timestamp for display
        const shortLabel = ts.replace('T', ' ').slice(5, 16);
        
        // Add to chart data if it's a chart point
        if (isChartPoint) {
          labels.push(shortLabel);
          co2.push(e.CO2 ?? 0);
          temp.push(e.temperature ?? 0);
          humidity.push(e.humidity ?? 0);
          methane.push(e.methane ?? 0);
        }
        
        // Add to CSV data
        csvData.push([ts, e.CO2, e.temperature, e.humidity, e.methane, e.analogvalues]);
        
        // For really large datasets, don't show every point in the table
        if (dataCount > 200 && index % Math.ceil(dataCount / 200) !== 0 && index !== keys.length - 1) {
          return;
        }
        
        // Create table row
        const row = document.createElement('tr');
        
        // Add cells
        [
          ts,
          e.CO2 ?? 'N/A',
          e.temperature ?? 'N/A',
          e.humidity ?? 'N/A',
          e.methane ?? 'N/A',
          e.analogvalues ?? 'N/A'
        ].forEach(value => {
          const cell = document.createElement('td');
          cell.textContent = value;
          row.appendChild(cell);
        });
        
        fragment.appendChild(row);
      });
      
      // Add all rows at once
      tbody.appendChild(fragment);
      
      // Update chart data all at once
      charts.co2.data.labels = 
      charts.temp.data.labels = 
      charts.humidity.data.labels = 
      charts.methane.data.labels = labels;
      
      charts.co2.data.datasets[0].data = co2;
      charts.temp.data.datasets[0].data = temp;
      charts.humidity.data.datasets[0].data = humidity;
      charts.methane.data.datasets[0].data = methane;
      
      // Update all charts without animations
      Object.values(charts).forEach(chart => chart.update(0));
      
      // Update stats
      updateStats(data);
      
      // Update record counter
      document.getElementById('records-count').textContent = `${dataCount} records found`;
    }
    
    // Download data as CSV
    function downloadCSV() {
      if (!csvData || csvData.length === 0) {
        showAlert('No data available to download');
        return;
      }
      
      // Create CSV content
      const csvContent = [
        ['Timestamp', 'CO2 (ppm)', 'Temperature (Â°C)', 'Humidity (%)', 'Methane (ppm)', 'Analog Values'],
        ...csvData
      ].map(row => row.join(',')).join('\n');
      
      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      
      // Prepare filename with current date
      const now = new Date();
      const filename = `environmental_data_${now.toISOString().split('T')[0]}.csv`;
      
      // Set up and click link to trigger download
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('Download started');
    }
    
    // Initialize date filters
    function initDateFilters() {
      // Set default date range (last 7 days)
      const today = new Date();
      const lastWeek = new Date();
      lastWeek.setDate(today.getDate() - 7);
      
      // Format dates for input fields
      const formatDate = date => date.toISOString().split('T')[0];
      
      document.getElementById('end-date').value = formatDate(today);
      document.getElementById('start-date').value = formatDate(lastWeek);
    }
    
    // Application initialization
    function init() {
      // Initialize Firebase
      initFirebase();
      
      // Initialize charts
      initCharts();
      
      // Initialize date filters
      initDateFilters();
      
      // Add event listener for refresh button
      document.getElementById('refresh-btn').addEventListener('click', fetchData);
      
      // Add event listener for export button
      document.getElementById('export-btn').addEventListener('click', downloadCSV);
      
      // Add event listener for date filter form
      document.getElementById('start-date').addEventListener('change', fetchData);
      document.getElementById('end-date').addEventListener('change', fetchData);
      
      // Handle window resize (for charts)
      window.addEventListener('resize', function() {
        Object.values(charts).forEach(chart => chart.resize());
      });
      
      // Initial data fetch
      fetchData();
    }
    
    // Initialize app when DOM is ready
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
